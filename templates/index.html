<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Planificador de Rutas</title>
    <link rel="stylesheet" href="/static/estilo.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body class="pagina">
    <div class="contenedor animar">
        <h1 class="titulo">Planificador de Rutas</h1>
        <form method="post" action="/rutas" class="formulario">
            <!-- Campos -->
            <label class="campo">Ciudad de Origen:
                <select name="origen" class="entrada">
                    {% for ciudad in ciudades %}
                    <option value="{{ ciudad }}">{{ ciudad }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="campo">Máximo de paquetes:
                <input name="max_carga" type="number" required class="entrada" />
            </label>
            <label class="campo">Máxima distancia:
                <input name="max_distancia" type="number" step="0.1" required class="entrada" />
            </label>
            <label class="campo">Máxima gasolina:
                <input name="max_gasolina" type="number" step="0.1" required class="entrada" />
            </label>
            <button class="boton">Generar rutas</button>
        </form>

        {% if resultados %}
        <h2 class="subtitulo">Rutas Generadas:</h2>
        <ul class="lista-rutas">
            {% for r in resultados %}
            <li class="ruta">
                <strong>Ruta {{ r.id }}:</strong> {{ r.ruta }}<br/>
                Peso: {{ r.peso }}<br/>
                Distancia: {{ r.distancia }}<br/>
                Gasolina: {{ r.gasolina }} Lts
            </li>
            {% endfor %}
        </ul>

        <!-- Mapa -->
        <h2 class="subtitulo">Vista en Mapa:</h2>
        <div id="map" style="height: 400px; margin-top: 20px; border-radius: 12px; overflow: hidden;"></div>
        {% endif %}
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    {% if resultados %}
    <script>
        const coord = {{ coordenadas_json | safe }};
        const rutas = {{ rutas_coords_json | safe }};
        const map = L.map('map').setView([19.4328, -99.1333], 5); // Centrado en CDMX

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © OpenStreetMap contributors',
        }).addTo(map);

        rutas.forEach(ruta => {
            const puntos = ruta.map(c => coord[c]);
            L.polyline(puntos, { color: '#2E86DE', weight: 4 }).addTo(map);

            ruta.forEach((c, i) => {
                const marker = L.marker(coord[c]).addTo(map);
                marker.bindPopup(`${c}`).openPopup();
                if (i === 0) marker.bindTooltip("Inicio").openTooltip();
            });
        });
    </script>
    {% endif %}
</body>
</html>
